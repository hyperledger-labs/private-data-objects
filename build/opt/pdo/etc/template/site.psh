#! /usr/bin/env pdo-shell

## Copyright 2018 Intel Corporation
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
##     http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.

if --null "${data}"
   echo data macro must be defined
   exit
fi

## load the local database if it exists
set --conditional -s dbfile --state Service EnclaveServiceDatabaseFile

## this returns false of the database file does not exist
## we can use this later to save the updates
eservice_db load --database ${dbfile} -s _database_exists_

## make sure the minimal set of enclave services is included
eservice_db add --url http://localhost:7101 --name es7101
eservice_db add --url http://localhost:7102 --name es7102
eservice_db add --url http://localhost:7103 --name es7103
eservice_db add --url http://localhost:7104 --name es7104
eservice_db add --url http://localhost:7105 --name es7105

if -e ${_database_exists_} False
   eservice_db save --database ${dbfile}
   echo eservice database updated
fi

## default pservice group
pservice add --url http://localhost:7001
pservice add --url http://localhost:7002
pservice add --url http://localhost:7003

## pservice group p1
pservice --group p1 add --url http://localhost:7003
pservice --group p1 add --url http://localhost:7004
pservice --group p1 add --url http://localhost:7005

## pservice group all
pservice --group all add --url http://localhost:7001
pservice --group all add --url http://localhost:7002
pservice --group all add --url http://localhost:7003
pservice --group all add --url http://localhost:7004
pservice --group all add --url http://localhost:7005

## default eservice group
eservice add --url http://localhost:7101 http://localhost:7102 http://localhost:7103
eservice use --url http://localhost:7101

## eservice group e2
eservice --group e2 add --url http://localhost:7102 http://localhost:7103 http://localhost:7104
eservice --group e2 use --url http://localhost:7102

## eservice group e3
eservice --group e2 add --url http://localhost:7103 http://localhost:7104 http://localhost:7105
eservice --group e2 use --url http://localhost:7103

## eservice group e4
eservice --group e4 add --url http://localhost:7104 http://localhost:7105 http://localhost:7101
eservice --group e4 use --url http://localhost:7104

## eservice group e5
eservice --group e5 add --url http://localhost:7105 http://localhost:7101 http://localhost:7102
eservice --group e5 use --url http://localhost:7105

## eservice group all
eservice --group all add --url http://localhost:7101 http://localhost:7102 http://localhost:7103 http://localhost:7104 http://localhost:7105
eservice --group all use --url http://localhost:7101
