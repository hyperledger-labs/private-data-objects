#! /usr/bin/env pdo-shell

## Copyright 2018 Intel Corporation
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
##     http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.

if --null "${data}"
   echo data macro must be defined
   exit
fi

## load the local database if it exists
set --conditional -s dbfile --state Service EnclaveServiceDatabaseFile

## this returns false of the database file does not exist
## we can use this later to save the updates
eservice_db load --database ${dbfile} -s _database_exists_

## make sure the minimal set of enclave services is included
## if these are already in the database they will not be re-added
eservice_db add --url http://localhost:7101 --name es7101
eservice_db add --url http://localhost:7102 --name es7102
eservice_db add --url http://localhost:7103 --name es7103
eservice_db add --url http://localhost:7104 --name es7104
eservice_db add --url http://localhost:7105 --name es7105

if -e ${_database_exists_} False
   eservice_db save --database ${dbfile}
   echo eservice database updated
fi

## -----------------------------------------------------------------
## -----------------------------------------------------------------

## default pservice group
pservice add --url http://localhost:7001
pservice add --url http://localhost:7002
pservice add --url http://localhost:7003

## pservice group p1
pservice --group p1 add --url http://localhost:7003
pservice --group p1 add --url http://localhost:7004
pservice --group p1 add --url http://localhost:7005

## pservice group all
pservice --group all add --url http://localhost:7001
pservice --group all add --url http://localhost:7002
pservice --group all add --url http://localhost:7003
pservice --group all add --url http://localhost:7004
pservice --group all add --url http://localhost:7005

## -----------------------------------------------------------------
## -----------------------------------------------------------------

## default eservice group
eservice add --url http://localhost:7101
eservice add --url http://localhost:7102
eservice add --url http://localhost:7103
eservice use --url http://localhost:7101

## eservice group e2
eservice --group e2 add --url http://localhost:7102
eservice --group e2 add --url http://localhost:7103
eservice --group e2 add --url http://localhost:7104
eservice --group e2 use --url http://localhost:7102

## eservice group e3
eservice --group e3 add --url http://localhost:7103
eservice --group e3 add --url http://localhost:7104
eservice --group e3 add --url http://localhost:7105
eservice --group e3 use --url http://localhost:7103

## eservice group e4
eservice --group e4 add --url http://localhost:7104
eservice --group e4 add --url http://localhost:7105
eservice --group e4 add --url http://localhost:7101
eservice --group e4 use --url http://localhost:7104

## eservice group e5
eservice --group e5 add --url http://localhost:7105
eservice --group e5 add --url http://localhost:7101
eservice --group e5 add --url http://localhost:7102
eservice --group e5 use --url http://localhost:7105

## eservice group all
eservice --group all add --url http://localhost:7101
eservice --group all add --url http://localhost:7102
eservice --group all add --url http://localhost:7103
eservice --group all add --url http://localhost:7104
eservice --group all add --url http://localhost:7105
eservice --group all use --url http://localhost:7101

## -----------------------------------------------------------------
## -----------------------------------------------------------------

set -s persistent_storage_service -v http://localhost:7201

## default sservice group
sservice add --url http://localhost:7201
sservice add --url http://localhost:7202
sservice add --url http://localhost:7203
sservice set --duration 120 --replicas 2 --persistent ${persistent_storage_service}

## sservice group s2
sservice --group s2 add --url http://localhost:7102
sservice --group s2 add --url http://localhost:7103
sservice --group s2 add --url http://localhost:7104
sservice --group s2 set --duration 120 --replicas 2 --persistent ${persistent_storage_service}

## sservice group s3
sservice --group s3 add --url http://localhost:7103
sservice --group s3 add --url http://localhost:7104
sservice --group s3 add --url http://localhost:7105
sservice --group s3 set --duration 120 --replicas 2 --persistent ${persistent_storage_service}

## sservice group s4
sservice --group s4 add --url http://localhost:7104
sservice --group s4 add --url http://localhost:7105
sservice --group s4 add --url http://localhost:7101
sservice --group s4 set --duration 120 --replicas 2 --persistent ${persistent_storage_service}

## sservice group s5
sservice --group s5 add --url http://localhost:7105
sservice --group s5 add --url http://localhost:7101
sservice --group s5 add --url http://localhost:7102
sservice --group s5 set --duration 120 --replicas 2 --persistent ${persistent_storage_service}

## all sservices
sservice --group all add --url http://localhost:7201
sservice --group all add --url http://localhost:7202
sservice --group all add --url http://localhost:7203
sservice --group all add --url http://localhost:7204
sservice --group all add --url http://localhost:7205
sservice --group all set --duration 3600 --replicas 3 --persistent ${persistent_storage_service}
